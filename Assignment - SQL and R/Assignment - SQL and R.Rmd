---
title: "Assignment - SQL and R"
author: "Jawaid Hakim"
date: "`r Sys.Date()`"
output:
  pdf_document: 
    toc: true
    number_sections: true
  
  html_document:
    toc: true
    toc_float: true
    number_sections: true
    
boxlinks: true
urlcolor: blue
always_allow_html: true
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Introduction
SQL databases are widely used repositories for mission critical data. This solution illustrates connection to SQL databases from R. Both local and remote databases are explored. A remote AWS RDS MySQL database is available out of the box. However, a local MySQL database can also be easily set up and configured for use with this solution.

# Database schema
Schema for this assignment is  normalized into 3 tables: FRIENDS, MOVIES, and RATINGS. Normalization has many benefits including efficient storage and reduced operational overhead. Each entity can evolve independently. For instance, adding additional details to FRIENDS, like the date of birth or address, can be done without impacting other entities. Additionally, database maintenance overhead is also reduced - e.g., changing the first name of a FRIEND can be done by updating just a single row.

## Primary Keys
FRIENDS and MOVIES tables each have a primary key named ID. This key is auto-generated by the database and the sequence is initialized to 1 - i.e. first record in table has ID = 1.

## Foreign Keys
Foreign key relationships are created to enforce referential integrity. In this schema, foreign key constraints have been set in the RATINGS table. Click [ER diagram](https://www.dropbox.com/s/acrv7b2nydb6x72/Model.png?dl=0) to see foreign key relationships.

## Missing Ratings
It is possible, even highly likely, that not all friends would have viewed all movies. This database schema accommodates this scenario by design - only rated movies need be loaded into RATINGS table. 

However, to allow 'NA' ratings to be loaded, the RATINGS.RATING columns is defined as an ENUM [0, 1, 2, 3, 4, 5], where 0 (default) is reserved for unrated movies.

# Database
This solution works with either a pre-configured remote AWS (RDS) MySQL database or a local MySQL database. 

## Remote AWS (RDS) MySQL Database
A pre-configured AWS MySQL database has been set up and pre-populated with data to make it easy to run this R solution. Creating the AWS MySQL database was straightforward using the wizard. One caveat was that the default security group rules do not permit access to RDS from external IP addresses. In other words, connection to RDS over the open internet is not allowed. 

To get around this limitation, I has to create a custom security group in AWS and configured it's **Inbound rules** as follows: **Protocol**: TCP, **Type**: MYSQL/AURORA, **Port range**: 3306, **Source**:0.0.0.0/0. Finally, I assigned this security group to the RDS database. With this in place RDS can be accessed over the internet from R Studio and MySQL Workbench.

Note: connection to any database assumes the server is in running state. Connection attempts will fail in case the preconfigured RDS database is shutdown.

### Test Remote Database Connection
To test connectivity to the RDS MySQL database do the following:

1. Start MySQL Workbench
1. Click **+** button next to **My SQLConnections**. The **Setup New Connection** windows will launch
1. **Connection name:** Enter any name of your choosing
1. **Hostname:** Enter the **Endpoint** of the RDS MySQL database. Endpoint for the pre-configured RDS database is **cuny-ds.c5iiratvieki.us-east-1.rds.amazonaws.com**
1. **Username**: Enter **guest** for the pre-configured RDS database
1. **Password:** Enter **guestpass** for the pre-configured RDS database 
1. Click **Test Connection** to validate connection then click **OK** to finish
1. Log into RDS MySQL using the new connection. The **Assignment - SQL and R** schema will be visible. Enjoy!

## Local Database Setup
Make sure you have MySQL and MySQL Workbench installed. Admin database privileges will be required for creating database

### Create Local Database
1. Download [schema creation script](https://github.com/himalayahall/DATA607/blob/main/Assignment%20-%20SQL%20and%20R/create_schema.sql) to local storage
1. In MySQL Workbench click **File - Open SQL Script**, select downloaded file to load into editor, and execute script. On successful execution, schema will be created in MySQL database. 

Script will also create a **guest** user (if one does not exist) identified by password **guestpass**.

### Populate Local Database
1. Load data into FRIENDS table
    + Download [FRIENDS data](https://github.com/himalayahall/DATA607/blob/main/Assignment%20-%20SQL%20and%20R/friends.csv) to local storage
    + In MySQL Workbench right-mouse click  **Assignment - SQL and R -> Tables -> FRIENDS** table and select **Table Data Import Wizard**. Use wizard to load downloaded FRIENDS data into the FRIENDS table
1. Load data into MOVIES table
    + Download [MOVIES data](https://github.com/himalayahall/DATA607/blob/main/Assignment%20-%20SQL%20and%20R/movies.csv) to local storage
    + In MySQL Workbench right-mouse click  **Assignment - SQL and R -> Tables -> MOVIES** table and select **Table Data Import Wizard**. Use wizard to load downloaded MOVIES data into the MOVIES table
1. Load data into RATINGS table
    + Download [RATINGS data](https://github.com/himalayahall/DATA607/blob/main/Assignment%20-%20SQL%20and%20R/ratings.csv) to local storage
    + In MySQL Workbench right-mouse click  **Assignment - SQL and R -> Tables -> RATINGS** table and select **Table Data Import Wizard**. Use wizard to load downloaded RATINGS data into the RATINGS table

```{r}
library(DBI)
library(RMySQL)
library(RMariaDB)
library(dplyr)
library(knitr)
```

# Database Connection
For security reasons, database connection details  may be stored in a **CNF** file and not exposed in R scripts. This R script uses this technique and the CNF file **must** be downloaded from github and installed as described below.

## Install CNF File
1. Download [CNF file](https://github.com/himalayahall/DATA607/blob/48f9648f8511223a73e0c5d1fa88bcc2d81fede6/Assignment%20-%20SQL%20and%20R/assignment_sql_and_r.cnf) to local storage in a folder that is accessible by R runtime e.g., current working directory. From the R console, run **getwd()** command to see the current working directory. To change the working directory, use the **setwd()** command. Make sure the downloaded CNF file is in the working directory.

Modify **assignment_sql_and_r.cnf** as appropriate for your MySQL installation. For example, CNF has two configurations: **local_movie_ratings** for a local MySQL database and **remote_movie_ratings** for the pre-configured AWS MySQL. Note: the local configuration assumes there is a **guest** database user.

Set variable with name of CNF file. As mentioned above, path to the CNF is the current working directory:

```{r setup-cnf}
cnf.settingsfile <- 'assignment_sql_and_r.cnf'
```

## Remote Database Connection
Create functions to connect to either the remote or local database. Remote database connections use the using the **RMySQL** driver and local connections use the **MariaDB** driver:

```{r remote-db-connection}
my.dbConnectRemote <- function() {
    cnf.group <- 'remote_movie_ratings'
    db <- dbConnect(RMySQL::MySQL(), default.file=cnf.settingsfile, group=cnf.group)
    db
}

my.dbConnectLocal <- function() {
cnf.group <- 'local_movie_ratings'
    db <- dbConnect(RMariaDB::MariaDB(), default.file=cnf.settingsfile, group=cnf.group)
    db
}

my.dbConnect <- function(rem_or_local = "remote") {
    if (startsWith(rem_or_local, 'r')) {
        db <- my.dbConnectRemote()
    } else {
        db <- my.dbConnectLocal()
    }
    db
}
```

#  Select Remote or Local Database
Select either the remote (default) or local database. To use the local (remote) database comment out below 'remote' ('local') connect statement and uncomment the 'local' ('remote') connect statement. Rest of the R script can remain unchanged:

```{r database-connect}
db <- my.dbConnect('remote') # AWS MySQL database
#db <- my.dbConnect('local') # Local MySQL database
```

As sanity check, list the tables. As expected, FRIENDS, MOIVIES, and RATINGS tables are listed.

```{r list-tables}
dbListTables(db)
```

# Load Data
Now we are ready to load data!

## Load FRIENDS and MOVIES Data
Load the FRIENDS table:

```{r load-friends}
qry <- 'SELECT * FROM FRIENDS ORDER BY FIRST_NAME, LAST_NAME'
rs <- dbSendQuery(db, qry)       # Send query for execution
friends <- dbFetch(rs, n=-1)     # Fetch query results
head(friends)                    # Display first few results
```

```{r include=FALSE}
dbClearResult(rs)     # Clear results cache
```

Load the MOVIES table:

```{r load-movies}
qry <- 'SELECT * FROM MOVIES ORDER BY TITLE'
rs <- dbSendQuery(db, qry)
movies <- dbFetch(rs, n=-1)
head(movies)
```

```{r include=FALSE}
dbClearResult(rs)     # Clear results cache
```

## Load Ratings Data
Finally, load RATINGS.  Since the database schema is normalized, join FRIENDS, MOVIES, and RATINGS tables to load aggregate ratings data.

```{r load-ratings}
qry <- 'SELECT f.FIRST_NAME, f.LAST_NAME, m.TITLE, r.RATING 
            FROM FRIENDS f, MOVIES m, RATINGS r 
            WHERE r.FRIEND_ID = f.ID AND r.MOVIE_ID = m.ID
            ORDER BY f.FIRST_NAME, f.LAST_NAME, m.TITLE'
rs <- dbSendQuery(db, qry)
ratings <- dbFetch(rs, n=-1)
head(ratings)
```

```{r include=FALSE}
dbClearResult(rs)     # Clear results cache
```

## Convert RATINGS.RATING to Integer
Enumerations in MySQL are stored as characters. This is not the most convenient representation because we may want to do numeric analysis on ratings, e.g. average movie rating. Convert RATING from character to integer. 

Notice that RATING column has Min. : 0. This is due to some rows have a RATING of 0 (missing rating). 

```{r convert-rating-to-int}
ratings <- ratings %>% mutate(RATING = as.integer(RATING))
summary(ratings)
```

A rating of 0 is assigned to unrated movies. Filter out rows for unrated movies. Notice that now, as expected, RATING column has Min. : 1.

```{r discard-unrated-movies}
ratings <- ratings %>% filter(RATING != 0)
summary(ratings)
```

# Close Database Connection
Be a good citizen: close the database connection.

```{r database-disconnect}
dbDisconnect(db)
```
